<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elasticsearch Live Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #fff; }
        .header { background: #2d2d2d; padding: 1rem; border-bottom: 2px solid #4a9eff; }
        .header h1 { color: #4a9eff; }
        .controls { padding: 1rem; background: #2d2d2d; border-bottom: 1px solid #555; }
        .btn { background: #4a9eff; color: white; border: none; padding: 0.5rem 1rem; margin: 0.25rem; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #357abd; }
        .btn.danger { background: #dc3545; }
        .btn.danger:hover { background: #c82333; }
        .dashboard { display: grid; grid-template-columns: 300px 1fr; height: calc(100vh - 140px); }
        .sidebar { background: #2d2d2d; padding: 1rem; border-right: 1px solid #555; overflow-y: auto; }
        .main-content { padding: 1rem; overflow-y: auto; }
        .index-item { background: #3d3d3d; margin: 0.5rem 0; padding: 0.75rem; border-radius: 4px; cursor: pointer; }
        .index-item:hover { background: #4d4d4d; }
        .index-item.active { background: #4a9eff; }
        .log-entry { background: #2d2d2d; margin: 0.5rem 0; padding: 1rem; border-radius: 4px; border-left: 4px solid #4a9eff; }
        .log-entry.error { border-left-color: #dc3545; }
        .log-entry.warning { border-left-color: #ffc107; }
        .log-entry.success { border-left-color: #28a745; }
        .log-meta { font-size: 0.85rem; color: #aaa; margin-bottom: 0.5rem; }
        .log-content { font-family: 'Courier New', monospace; background: #1a1a1a; padding: 0.75rem; border-radius: 4px; overflow-x: auto; }
        .status { padding: 0.5rem; background: #1a1a1a; color: #4a9eff; font-family: monospace; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .stat-card { background: #2d2d2d; padding: 1rem; border-radius: 4px; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #4a9eff; }
        .stat-label { color: #aaa; font-size: 0.9rem; }
        .filter-controls { margin-bottom: 1rem; }
        .filter-input { background: #3d3d3d; color: #fff; border: 1px solid #555; padding: 0.5rem; border-radius: 4px; margin: 0.25rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Elasticsearch Live Monitor</h1>
        <div class="status" id="status">Disconnected</div>
    </div>
    
    <div class="controls">
        <button class="btn" onclick="startMonitoring()">‚ñ∂Ô∏è Start Monitoring</button>
        <button class="btn danger" onclick="stopMonitoring()">‚èπÔ∏è Stop Monitoring</button>
        <button class="btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        <button class="btn" onclick="exportLogs()">üíæ Export Logs</button>
    </div>
    
    <div class="dashboard">
        <div class="sidebar">
            <h3>üìä Index Statistics</h3>
            <div id="indexStats"></div>
            
            <h3 style="margin-top: 2rem;">üìÅ Indices</h3>
            <div class="filter-controls">
                <input type="text" class="filter-input" placeholder="Filter indices..." id="indexFilter" onkeyup="filterIndices()">
            </div>
            <div id="indicesList"></div>
        </div>
        
        <div class="main-content">
            <div class="stats" id="globalStats"></div>
            
            <div class="filter-controls">
                <input type="text" class="filter-input" placeholder="Filter logs..." id="logFilter" onkeyup="filterLogs()">
                <select class="filter-input" id="typeFilter" onchange="filterLogs()">
                    <option value="">All Types</option>
                    <option value="workflow">Workflows</option>
                    <option value="task">Tasks</option>
                    <option value="log">Logs</option>
                    <option value="event">Events</option>
                    <option value="message">Messages</option>
                </select>
            </div>
            
            <div id="logsContainer"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let allLogs = [];
        let selectedIndex = null;
        
        socket.on('connect', function() {
            document.getElementById('status').textContent = 'Connected';
            document.getElementById('status').style.color = '#28a745';
        });
        
        socket.on('disconnect', function() {
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('status').style.color = '#dc3545';
        });
        
        socket.on('status', function(data) {
            document.getElementById('status').textContent = data.msg;
        });
        
        socket.on('error', function(data) {
            document.getElementById('status').textContent = 'Error: ' + data.msg;
            document.getElementById('status').style.color = '#dc3545';
        });
        
        socket.on('logs_update', function(data) {
            allLogs = data.logs;
            updateIndexStats(data.index_stats);
            updateGlobalStats(data.logs, data.index_stats);
            displayLogs(data.logs);
            updateIndicesList(Object.keys(data.index_stats));
        });
        
        function startMonitoring() {
            socket.emit('start_monitoring');
        }
        
        function stopMonitoring() {
            socket.emit('stop_monitoring');
        }
        
        function clearLogs() {
            allLogs = [];
            document.getElementById('logsContainer').innerHTML = '';
        }
        
        function exportLogs() {
            const dataStr = JSON.stringify(allLogs, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `elasticsearch-logs-${new Date().toISOString()}.json`;
            link.click();
        }
        
        function updateIndexStats(stats) {
            const container = document.getElementById('indexStats');
            let html = '';
            
            Object.entries(stats).forEach(([index, stat]) => {
                html += `
                    <div class="index-item" onclick="selectIndex('${index}')">
                        <strong>${index}</strong><br>
                        <small>Docs: ${stat['docs.count']} | Size: ${stat['store.size']}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateGlobalStats(logs, indexStats) {
            const container = document.getElementById('globalStats');
            const totalDocs = Object.values(indexStats).reduce((sum, stat) => sum + parseInt(stat['docs.count'] || 0), 0);
            const totalIndices = Object.keys(indexStats).length;
            const recentLogs = logs.length;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalIndices}</div>
                    <div class="stat-label">Total Indices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalDocs}</div>
                    <div class="stat-label">Total Documents</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${recentLogs}</div>
                    <div class="stat-label">Recent Logs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${new Date().toLocaleTimeString()}</div>
                    <div class="stat-label">Last Update</div>
                </div>
            `;
        }
        
        function updateIndicesList(indices) {
            const container = document.getElementById('indicesList');
            let html = '';
            
            indices.forEach(index => {
                const isActive = selectedIndex === index ? 'active' : '';
                html += `
                    <div class="index-item ${isActive}" onclick="selectIndex('${index}')">
                        ${index}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function selectIndex(index) {
            selectedIndex = index;
            updateIndicesList(Object.keys(document.querySelectorAll('.index-item')));
            filterLogs();
        }
        
        function displayLogs(logs) {
            const container = document.getElementById('logsContainer');
            let html = '';
            
            logs.forEach(log => {
                const logClass = getLogClass(log);
                const formattedSource = JSON.stringify(log.source, null, 2);
                
                html += `
                    <div class="log-entry ${logClass}">
                        <div class="log-meta">
                            <strong>${log.index}</strong> | ${log.doc_type} | ${log.timestamp} | ID: ${log.doc_id}
                        </div>
                        <div class="log-content">${formattedSource}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function getLogClass(log) {
            const source = JSON.stringify(log.source).toLowerCase();
            if (source.includes('error') || source.includes('failed')) return 'error';
            if (source.includes('warning') || source.includes('warn')) return 'warning';
            if (source.includes('success') || source.includes('completed')) return 'success';
            return '';
        }
        
        function filterIndices() {
            const filter = document.getElementById('indexFilter').value.toLowerCase();
            const items = document.querySelectorAll('#indicesList .index-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(filter) ? 'block' : 'none';
            });
        }
        
        function filterLogs() {
            const textFilter = document.getElementById('logFilter').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            
            let filteredLogs = allLogs.filter(log => {
                const matchesText = !textFilter || 
                    JSON.stringify(log.source).toLowerCase().includes(textFilter) ||
                    log.index.toLowerCase().includes(textFilter);
                
                const matchesType = !typeFilter || log.doc_type === typeFilter;
                const matchesIndex = !selectedIndex || log.index === selectedIndex;
                
                return matchesText && matchesType && matchesIndex;
            });
            
            displayLogs(filteredLogs);
        }
    </script>
</body>
</html>